<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bitcamp.gabojago.dao.RecommendationDao">

    <!-- 자바 객체의 프로퍼티와 컬럼 이름을 연결 -->
    <resultMap type="recommendation" id="recommendationMap">
        <result column="RECONO" property="recono"/>
        <result column="TITLE" property="title"/>
        <result column="CNT" property="cnt"/>
        <result column="WDATE" property="wdate"/>
        <result column="ACT" property="act"/>
        <result column="PET" property="pet"/>
        <result column="FRD" property="frd"/>
        <result column="CPLE" property="cple"/>
        <result column="FMLY" property="fmly"/>
        <result column="SOLO" property="solo"/>
        <result column="TPNO" property="tpno"/>

        <association property="writer" javaType="member">
            <id column="id" property="id"/>
            <result column="nname" property="nickName"/>
        </association>

        <collection property="jangSoReviews" ofType="jangSoReview">
            <id column="PRVNO" property="prvno"/>
            <result column="CONT" property="cont"/>
        </collection>

    </resultMap>

    <resultMap type="jangSoReview" id="jangSoReviewMap">
        <id column="prvno" property="prvno"/>
        <result column="cont" property="cont"/>
        <result column="recono" property="recono"/>
        <result column="plno" property="plno"/>

        <collection property="attachedFiles" ofType="jangSoReviewAttachedFile">
            <id column="recofno" property="recofno"/>
            <result column="filepath" property="filepath"/>
            <result column="fname" property="fname"/>
        </collection>

    </resultMap>

    <resultMap type="jangSoReviewAttachedFile" id="attachedFileMap">
        <id column="recofno" property="recofno"/>
        <result column="prvno" property="prvno"/>
        <result column="path" property="filepath"/>
        <result column="fname" property="fname"/>
    </resultMap>


    <select id="recommendationList" resultMap="recommendationMap">
        select
        recono, title, wdate
        from
        jang_so_recommendation
        where
        act=true
    </select>

    <insert id="recommendationAdd" parameterType="recommendation"
      useGeneratedKeys="true" keyColumn="recono" keyProperty="recono">
        insert into jang_so_recommendation(id, title, act, frd, cple, fmly, solo, tpno)
        values(#{writer.id}, #{title}, true, true, true, true, true, 1)
    </insert>

    <insert id="jangSoReviewAdd" parameterType="jangSoReview"
      useGeneratedKeys="true" keyColumn="prvno" keyProperty="prvno">
        insert into jang_so_review(cont,recono,plno)
        values(#{cont}, #{recono}, 1)
    </insert>

    <insert id="jangSoReviewAttachedFileAdd" parameterType="jangSoReviewAttachedFile">
        insert into jang_so_review_file(path,fname,prvno)
        values(#{filepath}, #{fname}, #{prvno})
    </insert>

<!--    <insert id="jangSoReviewAdd" parameterType="recommendation"-->
<!--      useGeneratedKeys="true" keyColumn="prvno" keyProperty="prvno">-->
<!--        insert into jang_so_review(cont,recono)-->
<!--        values-->
<!--        <foreach collection="jangSoReviews" item="jangSoReview" separator=",">-->
<!--            (#{jangSoReview.cont}, #{recono})-->
<!--        </foreach>-->
<!--    </insert>-->

<!--    <insert id="jangSoReviewAttachedFileAdd" parameterType="jangSoReview">-->
<!--        insert into jang_so_review_file(path,fname,prvno)-->
<!--        values-->
<!--        <foreach collection="attachedFiles" item="file" separator=",">-->
<!--            (#{file.filepath}, #{file.filename}, #{prvno})-->
<!--        </foreach>-->
<!--    </insert>-->

    <select id="getRecommendation" resultMap="recommendationMap">
        select
        recono,
        title,
        cnt,
        wdate,
        act,
        pet,
        frd,
        cple,
        fmly,
        solo,
        tpno
        from
        jang_so_recommendation
        where recono = #{value}
    </select>

    <update id="disableRecommend">
        update jang_so_recommendation set
        act=false
        where recono=#{recono}
    </update>
    
    
    <update id="setCntRecommendation">
        update jang_so_recommendation
        set
            cnt = (select cnt from jang_so_recommendation where recono = #{recono}) + 1
        where
            recono = #{recono}
    </update>
    <!-- 상세보기-->
    <!--    <select id="exhibitionSelect"  resultMap="exhibitionMap">-->
    <!--        select  * from jang_exhibition-->
    <!--        left join jang_exhibition_file on jang_exhibition.EXNO = jang_exhibition_file.EXNO-->
    <!--        left join jang_exhibition_review on jang_exhibition.EXNO = jang_exhibition_review.EXNO-->
    <!--        left join jang_so on jang_exhibition.PLNO = jang_so.PLNO-->
    <!--        where jang_exhibition.EXNO=#{value};-->
    <!--    </select>-->

    <!--    <insert id="exhibitionInsert"  parameterType="exhibition"-->
    <!--            useGeneratedKeys="true" keyColumn="exno" keyProperty="exno">-->

    <!--        INSERT INTO jangdb.jang_exhibition (exname, cont, plno, stdate, eddate, price)-->
    <!--        values (#{exname}, #{cont}, -1, #{stdate}, #{eddate}, #{price})-->

    <!--    </insert>-->

    <!--    <delete id="delete">-->
    <!--        delete from jang_exhibition_file-->
    <!--        where jang_exhibition_file.EXNO=#{value};-->
    <!--        delete from jang_exhibition_review-->
    <!--        where jang_exhibition_review.EXNO=#{value};-->
    <!--        delete from jang_ticket-->
    <!--        where jang_ticket.EXNO=#{value};-->
    <!--        delete from jang_baguni-->
    <!--        where jang_baguni.EXNO=#{value};-->
    <!--        delete from jang_exhibition-->
    <!--        where jang_exhibition.EXNO=#{value};-->

    <!--  리뷰 달려있으면 삭제 못함 -->

    <!--    </delete>-->


    <!--    <update id="update" parameterType="exhibition">-->
    <!--        update jang_exhibition set-->
    <!--        EXNAME= #{exname}, CONT= #{cont},-->
    <!--       STDATE= #{stdate}, EDDATE= #{eddate},-->
    <!--        PRICE= #{price}-->
    <!--        where jang_exhibition.EXNO= #{exno}-->
    <!--    </update>-->



</mapper>